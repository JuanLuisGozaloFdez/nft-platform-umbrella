name: Reports Scheduler

on:
  schedule:
    - cron: '0 3 * * *'  # Daily at 03:00 UTC
  workflow_dispatch:

jobs:
  regenerate-reports:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout umbrella repo
        uses: actions/checkout@v4

      - name: Setup Node and Python
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install GitHub CLI and jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          type -p curl >/dev/null || sudo apt-get install curl -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update -y
          sudo apt-get install -y gh
      
      - name: Auth GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth status || echo "$GH_TOKEN" | gh auth login --with-token

      - name: Run workflow status collection script
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f ./scripts/collect_workflow_status.sh ]; then
            chmod +x ./scripts/collect_workflow_status.sh
            ./scripts/collect_workflow_status.sh
          else
            echo "scripts/collect_workflow_status.sh not found; skipping this step"
          fi

      - name: Append aggregated summary to WORKFLOWS_VERIFICATION.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          repos=(
            "JuanLuisGozaloFdez/ticketing-core-service"
            "JuanLuisGozaloFdez/wallet-assets-service"
            "JuanLuisGozaloFdez/checkin-validation-service"
            "JuanLuisGozaloFdez/users-identity-service"
            "JuanLuisGozaloFdez/payments-orders-service"
            "JuanLuisGozaloFdez/notifications-comms-service"
            "JuanLuisGozaloFdez/admin-event-ops-service"
            "JuanLuisGozaloFdez/nft-marketplace-integration"
            "JuanLuisGozaloFdez/api-gateway-bff"
            "JuanLuisGozaloFdez/admin-web-portal"
            "JuanLuisGozaloFdez/mobile-app-fans"
            "JuanLuisGozaloFdez/checkin-scanner-app"
            "JuanLuisGozaloFdez/nft-platform-umbrella"
            "JuanLuisGozaloFdez/platform-infra"
            "JuanLuisGozaloFdez/nft-marketplace-backend-api"
            "JuanLuisGozaloFdez/nft-marketplace-smart-contracts"
          )
          ok=0; fail=0; none=0
          stamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          tmp=$(mktemp)
          {
            echo "## ðŸ“Š Workflows Summary (${stamp})"
            echo
            echo "| Repository | Status | Workflow | URL |"
            echo "|------------|--------|----------|-----|"
          } > "$tmp"
          for repo in "${repos[@]}"; do
            out=$(gh run list -R "$repo" --limit 1 --json status,workflowName,headBranch,htmlUrl 2>/dev/null || echo "[]")
            status=$(echo "$out" | jq -r '.[0].status // "-"')
            wf=$(echo "$out" | jq -r '.[0].workflowName // "-"')
            url=$(echo "$out" | jq -r '.[0].htmlUrl // "-"')
            echo "| $repo | $status | $wf | $url |" >> "$tmp"
            if [ "$status" = "completed" ]; then
              ok=$((ok+1))
            elif [ "$status" = "failed" ] || [ "$status" = "cancelled" ]; then
              fail=$((fail+1))
            else
              none=$((none+1))
            fi
          done
          {
            echo
            echo "- Success: $ok | Fail/Cancelled: $fail | Unknown/Pending: $none"
            echo
          } >> "$tmp"
          echo >> "$tmp"
          cat "$tmp" >> WORKFLOWS_VERIFICATION.md
          echo "Updated WORKFLOWS_VERIFICATION.md"

      - name: Commit and push reports
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          # Add only files that exist and have changes
          [ -f WORKFLOWS_VERIFICATION.md ] && git add WORKFLOWS_VERIFICATION.md || true
          if ! git diff --cached --quiet; then
            git commit -m "chore(reports): daily regeneration of workflow status and summaries"
            git push
          else
            echo "No changes to commit"
          fi