name: Platform CI/CD Umbrella

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Ejecutar diariamente a las 2 AM UTC para validaciones de seguridad
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Environment to deploy'
        required: false
        default: 'staging'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  REGISTRY: ghcr.io

jobs:
  # ============================================
  # FASE 1: ValidaciÃ³n y anÃ¡lisis paralelo
  # ============================================
  
  code-quality:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - ticketing-core-service
          - wallet-assets-service
          - checkin-validation-service
          - users-identity-service
          - payments-orders-service
          - notifications-comms-service
          - admin-event-ops-service
          - nft-marketplace-integration
          - api-gateway-bff
      max-parallel: 3
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Navigate to service
        run: |
          if [ -d "${{ matrix.service }}" ]; then
            cd "${{ matrix.service }}"
            npm ci
            npm run lint --if-present
            echo "âœ“ Linting passed for ${{ matrix.service }}"
          else
            echo "Service directory not found"
            exit 1
          fi

  frontend-quality:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app:
          - mobile-app-fans
          - admin-web-portal
          - checkin-scanner-app
      max-parallel: 3
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Navigate to app
        run: |
          if [ -d "${{ matrix.app }}" ]; then
            cd "${{ matrix.app }}"
            npm ci
            npm run lint --if-present
            npm run format:check --if-present || true
            echo "âœ“ Linting and formatting passed for ${{ matrix.app }}"
          else
            echo "App directory not found"
            exit 1
          fi

  infrastructure-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Cache Terraform plugin directory
        uses: actions/cache@v4
        with:
          path: ~/.terraform.d/plugin-cache
          key: terraform-plugin-cache-${{ runner.os }}
          restore-keys: |
            terraform-plugin-cache-
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false
      
      - name: Validate Terraform
        run: |
          cd platform-infra
          for dir in terraform/dev terraform/staging terraform/prod; do
            echo "Validating $dir"
            (cd "$dir" && mkdir -p ~/.terraform.d/plugin-cache && terraform init -backend=false -plugin-dir="${HOME}/.terraform.d/plugin-cache" && terraform validate)
          done
      - name: Install kube-linter
        run: |
          curl -sSL https://github.com/stackrox/kube-linter/releases/latest/download/kube-linter-linux.tar.gz | tar -xz
          sudo mv kube-linter /usr/local/bin/
      - name: Lint Kubernetes manifests (kube-linter)
        run: |
          if [ -d platform-infra/k8s ]; then
            kube-linter lint platform-infra/k8s || true
          else
            echo "platform-infra/k8s no existe. Saltando kube-linter."
          fi
        continue-on-error: true
      - name: Install Conftest
        run: |
          curl -L https://github.com/open-policy-agent/conftest/releases/download/v0.45.0/conftest_linux_amd64.tar.gz | tar -xz
          sudo mv conftest /usr/local/bin/
      - name: Policy check with Conftest (K8s)
        run: |
          # Si existen polÃ­ticas en platform-infra/policy y manifiestos k8s, ejecutar conftest
          if [ -d platform-infra/policy ] && [ -d platform-infra/k8s ]; then
            conftest test platform-infra/k8s -p platform-infra/policy || true
          else
            echo "Sin polÃ­ticas o manifiestos K8s. Saltando conftest."
          fi
        continue-on-error: true

  security-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy FS scan
        uses: aquasecurity/trivy-action@0.13.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'

  # ============================================
  # FASE 2: Tests
  # ============================================
  
  backend-tests:
    runs-on: ubuntu-latest
    needs: code-quality
    strategy:
      matrix:
        service:
          - ticketing-core-service
          - wallet-assets-service
          - checkin-validation-service
          - users-identity-service
          - payments-orders-service
          - notifications-comms-service
          - admin-event-ops-service
          - nft-marketplace-integration
          - api-gateway-bff
      max-parallel: 2
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Run tests
        run: |
          cd "${{ matrix.service }}"
          npm ci
          npm test -- --coverage || true
          echo "âœ“ Tests completed for ${{ matrix.service }}"
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test

  frontend-tests:
    runs-on: ubuntu-latest
    needs: frontend-quality
    strategy:
      matrix:
        app:
          - mobile-app-fans
          - admin-web-portal
          - checkin-scanner-app
      max-parallel: 2
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Run tests
        run: |
          cd "${{ matrix.app }}"
          npm ci
          npm test -- --coverage --watchAll=false || true
          echo "âœ“ Tests completed for ${{ matrix.app }}"

  # ============================================
  # FASE 3: Build
  # ============================================
  
  build-services:
    runs-on: ubuntu-latest
    needs: backend-tests
    strategy:
      matrix:
        service:
          - ticketing-core-service
          - wallet-assets-service
          - checkin-validation-service
          - users-identity-service
          - payments-orders-service
          - notifications-comms-service
          - admin-event-ops-service
          - nft-marketplace-integration
          - api-gateway-bff
      max-parallel: 3
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Build service
        run: |
          cd "${{ matrix.service }}"
          npm ci
          npm run build
          echo "âœ“ Build completed for ${{ matrix.service }}"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.service }}
          path: ${{ matrix.service }}/dist/
          retention-days: 1

  build-apps:
    runs-on: ubuntu-latest
    needs: frontend-tests
    strategy:
      matrix:
        app:
          - mobile-app-fans
          - admin-web-portal
          - checkin-scanner-app
      max-parallel: 3
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Build app
        run: |
          cd "${{ matrix.app }}"
          npm ci
          npm run build
          echo "âœ“ Build completed for ${{ matrix.app }}"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.app }}
          path: ${{ matrix.app }}/dist/
          retention-days: 1

  # ============================================
  # FASE 4: Docker Images (solo para push a main/develop)
  # ============================================
  
  push-images:
    runs-on: ubuntu-latest
    needs: [ build-services, build-apps ]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    strategy:
      matrix:
        service:
          - ticketing-core-service
          - wallet-assets-service
          - checkin-validation-service
          - users-identity-service
          - payments-orders-service
          - notifications-comms-service
          - admin-event-ops-service
          - nft-marketplace-integration
          - api-gateway-bff
      max-parallel: 3
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/ticketing-system/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha,prefix={{branch}}-
      
      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # FASE 5: Deployment (solo en main)
  # ============================================
  
  deploy:
    runs-on: ubuntu-latest
    needs: push-images
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        if: env.AWS_ACCESS_KEY_ID != '' && env.AWS_SECRET_ACCESS_KEY != ''
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: v1.28.0
      
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ticketing-prod --region eu-west-1
      
      - name: Deploy to Kubernetes
        run: |
          cd platform-infra/k8s/overlays/prod
          kubectl apply -k .
          kubectl rollout status deployment -n ticketing --all
      
      - name: Verify deployment
        run: |
          kubectl get pods -n ticketing
          kubectl get services -n ticketing

  # ============================================
  # FASE 6: Notificaciones y Reporte
  # ============================================
  
  notify:
    runs-on: ubuntu-latest
    needs: [ code-quality, frontend-quality, infrastructure-validation, backend-tests, frontend-tests, build-services, build-apps ]
    if: always()
    
    steps:
      - name: Determine workflow status
        id: status
        run: |
          if [ "${{ needs.code-quality.result }}" == "failure" ] || \
             [ "${{ needs.frontend-quality.result }}" == "failure" ] || \
             [ "${{ needs.backend-tests.result }}" == "failure" ] || \
             [ "${{ needs.frontend-tests.result }}" == "failure" ] || \
             [ "${{ needs.build-services.result }}" == "failure" ] || \
             [ "${{ needs.build-apps.result }}" == "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.24.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: env.SLACK_WEBHOOK_URL != ''
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ steps.status.outputs.emoji }} *Platform CI/CD Pipeline*\nStatus: *${{ steps.status.outputs.status }}*\nBranch: `${{ github.ref_name }}`\nCommit: ${{ github.sha }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

  summary:
    runs-on: ubuntu-latest
    needs: [ code-quality, frontend-quality, infrastructure-validation, security-checks, backend-tests, frontend-tests, build-services, build-apps ]
    if: always()
    
    steps:
      - name: Print workflow summary
        run: |
          echo "## ðŸ“Š Platform CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Quality | ${{ needs.frontend-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure Validation | ${{ needs.infrastructure-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Checks | ${{ needs.security-checks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Tests | ${{ needs.backend-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Tests | ${{ needs.frontend-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Services | ${{ needs.build-services.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Apps | ${{ needs.build-apps.result }} |" >> $GITHUB_STEP_SUMMARY
